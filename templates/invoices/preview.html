{% load static %}
<!doctype html>
<html lang="nl">
<head>
  <meta charset="utf-8" />
  <title>Factuurvoorbeeld {{ invoice.number|default:"(concept)" }}</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root { --fg:#0f172a; --muted:#475569; --line:#e2e8f0; --soft:#f8fafc; --chip:#eef2ff; --brand:#0f766e; }
    * { box-sizing: border-box; }
    body { margin:0; font:14px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,sans-serif; color:var(--fg); background:#f1f5f9; }
    .wrap { max-width: 900px; margin: 24px auto; padding: 0 16px; }
    .toolbar { display:flex; justify-content:space-between; align-items:center; margin-bottom:12px; }
    .btn { display:inline-block; padding:8px 12px; border-radius:8px; border:1px solid var(--line); background:white; text-decoration:none; color:var(--fg); }
    .btn.primary { background:var(--brand); color:white; border-color:var(--brand); }
    .card { background:white; border:1px solid var(--line); border-radius:16px; padding:24px; box-shadow: 0 2px 8px rgba(15,23,42,.04); position: relative; }

    /* geef ruimte voor de (lagere) footer, maar niet te veel */
    .card { padding-bottom: 24mm; }   /* pas aan naar 22–28mm indien nodig */

    @media print {
      .card { padding-bottom: 24mm; } /* idem op print */
    }

    /* Kop */
    .head { display:flex; justify-content:space-between; align-items:flex-start; gap:24px; }
    .h-left { flex: 1 1 auto; }
    .meta { color:var(--muted); }
    .meta strong { display:block; color:var(--fg); font-size:16px; margin-top:4px; }
    .org-block { color:var(--muted); margin-top:6px; }

    /* Logo alleen digitaal */
    .brand-logo { width: 38mm; height:auto; display:block; margin:0 0 8mm 0; }

    hr { border:0; height:1px; background:var(--line); margin:20px 0; }
    .grid2 { display:grid; grid-template-columns: 1fr 1fr; gap:24px; }
    .box-title { font-weight:600; margin-bottom:4px; }
    .muted { color:var(--muted); }

    table { width:100%; border-collapse: collapse; }
    th, td { padding:10px 8px; border-bottom:1px solid var(--line); vertical-align:top; }
    thead th { background:var(--soft); text-align:left; font-weight:600; }
    td.num, th.num { text-align:right; white-space:nowrap; }

    .totals { margin-top:12px; display:flex; justify-content:flex-end; }
    .totals .tbox { width: min(420px, 100%); }
    .row { display:flex; justify-content:space-between; padding:6px 0; }
    .row.total { border-top:1px solid var(--line); margin-top:6px; padding-top:10px; font-weight:700; }

    /* Betaling callout — kleiner en op één regel */
    .paycall{
      margin:12px 0 10px;
      padding:10px 12px;
      border:1px solid var(--line);
      border-radius:10px;
      background:#fafafa;
      font-size:11px;        /* was 15px */
      text-align:center;     /* centrum */
      white-space:nowrap;    /* forceer 1 regel */
    }
    .paycall .ogm{
      font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;
      letter-spacing:0;      /* was .5px, scheelt breedte */
    }

    /* Opmerking — één box vóór de tabel, met 3 subtiele lijnen */
    .note-box{
      margin:14px 0 12px;
      border:1px solid var(--line);
      border-radius:10px;
      background:#fff;
      padding:10px 12px;
    }
    .note-head{ font-weight:600; margin:0 0 6px; }
    .note-top{
      height:6px; margin:2px 0 8px;
      background:
        linear-gradient(var(--line),var(--line)) 0 0/100% 1px no-repeat,
        linear-gradient(var(--line),var(--line)) 0 2px/100% 1px no-repeat,
        linear-gradient(var(--line),var(--line)) 0 4px/100% 1px no-repeat;
    }
.note-body{ white-space:pre-wrap; }

    /* FOOTER — hard zichtbaar maken */
    .invoice-footer{
      position: fixed;
      left: 0; right: 0;
      bottom: 6mm;                 /* lager/hoger zetten kan hier */
      z-index: 10;          /* boven álles */
      border-top: 1px solid #e2e8f0;
      background: transparent;         /* eigen achtergrond */
      padding-top: 4px;
      font-size: 10.5px;
      line-height: 1.35;
      text-align: center;          /* centreren */
      visibility: visible !important;
      opacity: 1 !important;
    }

    /* centreer de inhoud binnen je max breedte */
    .invoice-footer .wrap{
      max-width: 900px;
      margin: 0 auto;
      padding: 0 8px;
    }
    /* compact en gecentreerd */
    .footer-row{
      display:flex;
      flex-wrap:wrap;
      justify-content:center;      /* centreren */
      gap: 3px 8px;                /* compacter */
      align-items:center;
    }
    .footer-sep{ opacity:.5; }

    /* Print */
    @media print {
      .toolbar { display:none !important; }
      body { background:white; }
      .card { box-shadow:none; border-color:#ddd; }
      .brand-logo { width:38mm; }
      .invoice-footer{ bottom: 5mm; }
      /* print: kleiner, gecentreerd, één regel — forceer met !important */
      .paycall{
        font-size: 10.5px !important;
        line-height: 1.2 !important;
        text-align: center !important;
        white-space: nowrap !important;
        padding: 6px 8px !important;
      }
      .notes-print { display:none; }
    }

    /* Scherm */
    .notes-print { display:none; }
  </style>
</head>
<body>

  {# Briefpapier-achtergrond enkel digitaal #}
  {% if request.GET.papier|default:"digitaal" != "voorbedrukt" %}
    {% include "invoices/_letterhead.html" %}
  {% endif %}

  {# Adresvenster (positie & guides geregeld in _address_window.html) #}
  {% include "invoices/_address_window.html" %}

  <div class="wrap">
    <div class="toolbar">
      <div style="font-weight:700;">Voorbeeld factuur</div>
      <div>
        <a href="javascript:window.print()" class="btn primary">Print / PDF</a>
        <a href="/admin/core/invoice/{{ invoice.pk }}/change/" class="btn">Terug naar admin</a>
      </div>
    </div>

    <div class="card">
      {# Logo alleen bij digitaal papier #}
      {% if request.GET.papier|default:"digitaal" != "voorbedrukt" %}
        <img src="{% static 'branding/spiegelven-logo.svg' %}" alt="Spiegelven" class="brand-logo">
      {% endif %}

      <div class="head">
        <div class="h-left">
          <div class="meta" id="invoice-meta">
            <div>Factuurnummer</div>
            <strong>{{ invoice.number|default:"(nog geen nummer)" }}</strong>
            <div>Datum</div>
            <strong>{{ invoice.issue_date|date:"d/m/Y" }}</strong>
            <div>Status</div>
            <strong>{{ invoice.get_status_display|default:invoice.status }}</strong>
          </div>
        </div>
      </div>

      <hr>

      {% if invoice.notes %}
        <div class="note-box">
          <div class="note-head">Opmerking</div>
          <div class="note-top"></div>
          <div class="note-body">{{ invoice.notes }}</div>
        </div>
      {% endif %}

      <div class="table">
        <table>
          <thead>
            <tr>
              <th style="width:46%">Omschrijving</th>
              <th class="num" style="width:9%">Aantal</th>
              <th class="num" style="width:15%">Eenheidsprijs</th>
              <th class="num" style="width:8%">BTW</th>
              <th class="num" style="width:11%">Excl.</th>
              <th class="num" style="width:11%">BTW-bedrag</th>
              <th class="num" style="width:11%">Incl.</th>
            </tr>
          </thead>
          <tbody>
            {% for l in lines %}
              <tr>
                <td>{{ l.description }}</td>
                <td class="num">{{ l.quantity|floatformat:"0" }}</td>
                <td class="num">{{ l.unit_price_excl|floatformat:"2" }}</td>
                <td class="num">{{ l.vat_rate }}</td>
                <td class="num">{{ l.line_excl|floatformat:"2" }}</td>
                <td class="num">{{ l.vat_amount|floatformat:"2" }}</td>
                <td class="num">{{ l.line_incl|floatformat:"2" }}</td>
              </tr>
            {% empty %}
              <tr>
                <td colspan="7" class="muted">Geen regels.</td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>

      {% if vat_summary %}
      <div style="margin-top:12px">
        <div class="box-title">Samenvatting per BTW-tarief</div>
        <table>
          <thead>
            <tr>
              <th>Tarief</th>
              <th class="num">Excl.</th>
              <th class="num">BTW</th>
              <th class="num">Incl.</th>
            </tr>
          </thead>
          <tbody>
            {% for r in vat_summary %}
            <tr>
              <td>{{ r.rate }}</td>
              <td class="num">{{ r.excl|floatformat:"2" }}</td>
              <td class="num">{{ r.vat|floatformat:"2" }}</td>
              <td class="num">{{ r.incl|floatformat:"2" }}</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
      {% endif %}

      <div class="totals">
        <div class="tbox">
          <div class="row"><div class="muted">Totaal excl.</div><div>{{ totals.excl }}</div></div>
          <div class="row"><div class="muted">BTW</div><div>{{ totals.vat }}</div></div>
          <div class="row total"><div>Totaal incl.</div><div>{{ totals.incl }}</div></div>
        </div>
      </div>

      {% if payment.iban or payment.ogm %}
      <div class="paycall">
        <strong>Gelieve te betalen op naam van {{ org.name }}</strong>
        {% if payment.iban %} — IBAN: <strong>{{ payment.iban }}</strong>{% endif %}
        {% if payment.ogm %} — Gestructureerde mededeling (OGM): <strong class="ogm">{{ payment.ogm }}</strong>{% endif %}
        {% if payment.bic %} — BIC: {{ payment.bic }}{% endif %}
      </div>
      {% endif %}

    </div> <!-- /.card -->
  </div>   <!-- /.wrap -->

  {% if request.GET.papier|default:"digitaal" != "voorbedrukt" %}
    {% include "invoices/_footer_org.html" %}
  {% endif %}

</body>
</html>