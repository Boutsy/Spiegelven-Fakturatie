{% load static helpers %}
<!doctype html>
<html lang="nl">
<head>
  <meta charset="utf-8" />
  <title>Factuurvoorbeeld {{ invoice.number|default:"(concept)" }}</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root { --fg:#0f172a; --muted:#475569; --line:#e2e8f0; --soft:#f8fafc; --chip:#eef2ff; --brand:#0f766e; }
    * { box-sizing: border-box; }
    body { margin:0; font:14px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,sans-serif; color:var(--fg); background:#f1f5f9; }
    .wrap { max-width: 900px; margin: 24px auto; padding: 0 16px; }
    .toolbar { display:flex; justify-content:space-between; align-items:center; margin-bottom:12px; }
    .btn { display:inline-block; padding:8px 12px; border-radius:8px; border:1px solid var(--line); background:white; text-decoration:none; color:var(--fg); }
    .btn.primary { background:var(--brand); color:white; border-color:var(--brand); }
    .card { background:white; border:1px solid var(--line); border-radius:16px; padding:24px; box-shadow: 0 2px 8px rgba(15,23,42,.04); position: relative; }

    /* geef ruimte voor de (lagere) footer, maar niet te veel */
    .card { padding-bottom: 24mm; }   /* pas aan naar 22–28mm indien nodig */

    @media print {
      .card { padding-bottom: 24mm; } /* idem op print */
    }

    /* Kop */

    /* Meta-balk boven de opmerking */
    .meta-bar{
      display:grid;
      grid-template-columns: 1fr auto 1fr; /* links | midden | rechts */
      align-items:center;
      column-gap:12px;
      margin: -6px 0 10px;   /* compact */
      font-size:13px;
    }
    .meta-bar .left   { text-align:left;  }
    .meta-bar .center { text-align:center; font-weight:700; }
    .meta-bar .right  { text-align:right; }

    @media print{
      .meta-bar{ font-size:12px; }
    }

    .head { display:flex; justify-content:space-between; align-items:flex-start; gap:24px; }
    .h-left { flex: 1 1 auto; }
    .meta { color:var(--muted); }
    .meta strong { display:block; color:var(--fg); font-size:16px; margin-top:4px; }
    .org-block { color:var(--muted); margin-top:6px; }

    /* Logo alleen digitaal */
    .brand-logo { width: 38mm; height:auto; display:block; margin:0 0 8mm 0; }
    @media print{
      .screen-only{ display:none !important; }
    }

    hr { border:0; height:1px; background:var(--line); margin:20px 0; }
    .grid2 { display:grid; grid-template-columns: 1fr 1fr; gap:24px; }
    .box-title { font-weight:600; margin-bottom:4px; }
    .muted { color:var(--muted); }

    table { width:100%; border-collapse: collapse; }
    th, td { padding:10px 8px; border-bottom:1px solid var(--line); vertical-align:top; }
    thead th { background:var(--soft); text-align:left; font-weight:600; }
    td.num, th.num { text-align:right; white-space:nowrap; }

    /* --- COMPACTERE FACTUURLIJNEN (alleen de tabel) --- */
    .table thead th{
  font-size:12.5px;    /* was ~14px */
  padding:6px 6px;     /* was 10px 8px */
  line-height:1.25;
    }
    .table tbody td{
      font-size:12.5px;
      padding:4px 6px;     /* iets minder verticale padding => lagere rijhoogte */
      line-height:1.25;
    }
    @media print{
      .table thead th,
      .table tbody td{
        font-size:11.5px;  /* print nóg iets compacter */
        padding:3px 5px;
        line-height:1.18;
      }
    }

    /* Totalen: kadertje rechts, waarden decimaal uitgelijnd en 1cm van rechterrand */
    /* Plaats totalen rechts, linkerrand exact op het midden van de pagina */
    .totals{
      margin-top:12px;
      display:grid;
      grid-template-columns: 1fr 1fr; /* links en rechts elk 50% */
      column-gap:12px;
      align-items:start;
      justify-items:end; 
    }
    .totals > .totals-card{
      grid-column: 2;     /* in de rechterkolom */
      justify-self: end;  /* tegen de rechterrand van kolom 2 */
      width: auto;        /* laat de inhoud de breedte bepalen */
      max-width: 420px;   /* jouw bestaande max-breedte behouden */
    }
    .totals-card{
      width: min(420px, 100%);
      border:1px solid var(--line);
      border-radius:10px;
      background:#fff;
      padding:10px 12px;
    }
    .totals-card .row{
      display:grid;
      grid-template-columns: 1fr auto; /* label | waarde */
      align-items:baseline;
      padding:4px 0;
      column-gap: 10mm;  /* ≈ 1 cm extra ruimte tussen titel en bedrag */
    }
    .totals-card .row.total{
      border-top:1px solid var(--line);
      margin-top:6px;
      padding-top:8px;
      font-weight:700;
    }
    .totals-card .label{ color:var(--muted); }
    .totals-card .value{
      display:inline-flex;
      align-items:baseline;
      gap:2px;
      padding-right:5mm;         /* ⇠ cijfers ±1cm naar links t.o.v. rand */
      font-variant-numeric: tabular-nums; /* gelijke tekenbreedte */
    }
    .totals-card .value .curr{ margin-right:2px; }
    .totals-card .value .int{ text-align:right; }
    .totals-card .value .dec{ min-width: 2ch; } /* ',00' blijft mooi uitgelijnd */

    /* Stempel rechtsboven OP het papier (binnen .card) */
    .doc-stamp{
      position: absolute;    /* relatieve positionering t.o.v. .card */
      top: 8mm;              /* pas aan naar smaak */
      right: 8mm;            /* pas aan naar smaak */
      font-size: 26px;       /* groter zichtbaar op scherm */
      font-weight: 800;
      letter-spacing: .5px;
      color: #0f172a;
      pointer-events: none;  /* geen klik-interactie */
      z-index: 1;            /* boven inhoud binnen de kaart */
    }

    @media print{
      .doc-stamp{
        top: 8mm;
        right: 8mm;
        font-size: 28px;     /* print iets groter kan */
      }
    }

    /* Zorg dat hij op scherm zeker zichtbaar is */
    @media screen{
      .doc-stamp{
        display: block !important;
        opacity: 1 !important;
        visibility: visible !important;
      }
    }

    /* Betaling callout — kleiner en op één regel */
    .paycall{
      margin:12px 0 10px;
      padding:10px 12px;
      border:1px solid var(--line);
      border-radius:10px;
      background:#fafafa;
      font-size:11px;        /* was 15px */
      text-align:center;     /* centrum */
      white-space:nowrap;    /* forceer 1 regel */
    }
    .paycall .ogm{
      font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;
      letter-spacing:0;      /* was .5px, scheelt breedte */
    }

    /* Opmerking — één box vóór de tabel, met 3 subtiele lijnen */
    .note-box{
      margin:14px 0 12px;
      border:1px solid var(--line);
      border-radius:10px;
      background:#fff;
      padding:10px 12px;
    }
      height:6px; margin:2px 0 8px;
      background:
        linear-gradient(var(--line),var(--line)) 0 0/100% 1px no-repeat,
        linear-gradient(var(--line),var(--line)) 0 2px/100% 1px no-repeat,
        linear-gradient(var(--line),var(--line)) 0 4px/100% 1px no-repeat;
    }

    /* Zorg dat de stempel ook op het scherm getoond wordt */
    @media screen{
      .doc-stamp{
        display:block !important;
        opacity:1 !important;
        visibility:visible !important;
      }
    }

    .note-body{ white-space:pre-wrap; }

    /* Meta-box boven opmerking (zelfde breedte als note-box) */
    .meta-box{
      margin: 20mm 0 12px;  /* ~2 cm naar beneden */
      border:1px solid var(--line);
      border-radius:10px;
      background:#fff;
      padding:10px 12px;
    }
    .meta-grid{
      display:grid;
      grid-template-columns: 1fr auto 1fr; /* links | midden | rechts */
      align-items:center;
      column-gap:12px;
      font-size:13px;
    }
    .meta-cell{ display:flex; gap:6px; align-items:baseline; }
    .meta-cell .label{ color:var(--muted); font-weight:600; }
    .meta-cell .value{ font-weight:700; }
    .meta-grid .left   { justify-content:flex-start; }
    .meta-grid .center { justify-content:center;   text-align:center; }
    .meta-grid .right  { justify-content:flex-end; text-align:right; }

    @media print{
      .meta-grid{ font-size:12px; }
    }

    /* FOOTER — hard zichtbaar maken */
    .invoice-footer{
      position: fixed;
      left: 0; right: 0;
      bottom: 6mm;                 /* lager/hoger zetten kan hier */
      z-index: 10;          /* boven álles */
      border-top: 1px solid #e2e8f0;
      background: transparent;         /* eigen achtergrond */
      padding-top: 4px;
      font-size: 10.5px;
      line-height: 1.35;
      text-align: center;          /* centreren */
      visibility: visible !important;
      opacity: 1 !important;
    }

    /* centreer de inhoud binnen je max breedte */
    .invoice-footer .wrap{
      max-width: 900px;
      margin: 0 auto;
      padding: 0 8px;
    }
    /* compact en gecentreerd */
    .footer-row{
      display:flex;
      flex-wrap:wrap;
      justify-content:center;      /* centreren */
      gap: 3px 8px;                /* compacter */
      align-items:center;
    }
    .footer-sep{ opacity:.5; }

    /* Print */
    @media print {
      .toolbar { display:none !important; }
      body { background:white; }
      .card { box-shadow:none; border-color:#ddd; }
      .brand-logo { width:38mm; }
      .invoice-footer{ bottom: 5mm; }
      /* print: kleiner, gecentreerd, één regel — forceer met !important */
      .paycall{
        font-size: 10.5px !important;
        line-height: 1.2 !important;
        text-align: center !important;
        white-space: nowrap !important;
        padding: 6px 8px !important;
      }
      .notes-print { display:none; }
    }

    /* Scherm */
    .notes-print { display:none; }

    .pay-card .label{ color:var(--muted); font-weight:600; }
    .pay-card .value{ font-weight:700; }
    .pay-card .ogm{
      font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;
      letter-spacing:.3px;
    }

    /* Rij met links: betaling (flexibel), rechts: totalen (vaste breedte) */
    .summary-row{
      margin-top:12px;
      display:grid;
      grid-template-columns: 1fr auto;  /* links vult over, rechts houdt eigen breedte */
      column-gap:12px;
      align-items: stretch;              /* kaarten even hoog */
    }

    /* Forceer plaatsing in de grid: pay links, totalen rechts */
    .summary-row .pay-card{ grid-column: 1; }
    .summary-row .totals-card{
      grid-column: 2;
      justify-self: end;     /* rechts uitlijnen */
      width: min(420px, 100%);
    }

    /* Pay-kaart: zelfde look als totalen, maar vult links-kolom volledig */
    .pay-card{
      width: 100%;
      border:1px solid var(--line);
      border-radius:10px;
      background:#fff;
      padding:10px 12px;
      font-size:12px;
      line-height:1.3;
      height:100%;                       /* gelijke hoogte met totalen */
      display:flex;
      flex-direction:column;
    }
    .pay-card .row{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:baseline;
      padding:4px 0;
    }
    .pay-card .label{ color:var(--muted); font-weight:600; }
    .pay-card .value{ font-weight:700; }
    .pay-card .ogm{
      font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;
      letter-spacing:.3px;
    }
    .pay-card .sep{ opacity:.6; margin:0 6px; }

    /* Pay-kaart: titel en centreren van alle regels */
    .pay-card{ text-align: left; }
    .pay-card .row{ justify-content: flex-start; }
    .pay-card .pay-title{
      font-weight: 700;
      margin: 2px 0 6px;
    }

    /* totalenkaart ook laten meerekken in de grid-rij */
    .totals-card{ height:100%; }

  </style>

  {% if request.GET.papier|default:"digitaal" == "voorbedrukt" %}
  <style>
    /* Alleen voor VOORBEDRUKT papier:
       - Reserveer plaats onder het adresvenster
      - Positioneer de stempel netjes binnen het papier
    */

    /* Voor het voorbeeld op scherm ook laten zien */
    @media screen{
      .card{ padding-top: 58mm; }     /* pas 54–62mm aan naar smaak */
      .doc-stamp{ top: 16mm; }
    }

    /* Echte print / PDF */
    @media print{
      .card{ padding-top: 38mm !important; }  /* ruimte onder adresvak */
      .doc-stamp{ top: 5mm !important; }     /* stempel blijft mooi rechtsboven */
    }
  </style>
  {% endif %}
</head>
<body>

  {# Footer : alleen bij digitaal #}
  {% if request.GET.papier|default:"digitaal" == "digitaal" %}
    {% include "invoices/_footer_org.html" %}
  {% endif %}

  {# Forceer adresvenster zichtbaar op scherm bij papier=digitaal #}
  {% if request.GET.papier|default:"digitaal" == "digitaal" %}
    <style id="address-screen-override">
      @media screen{
        .address-window{
          display:block !important;
          visibility:visible !important;
          opacity:1 !important;
          z-index:60 !important;      /* boven de kaart/inhoud */
          pointer-events:none;         /* kliks niet blokkeren */
        }
      }
    </style>
  {% endif %}

  {# Adresvenster (positie & guides geregeld in _address_window.html) #}
  {% include "invoices/_address_window.html" %}

  <div class="wrap">
    <div class="toolbar">
      <div style="font-weight:700;">Voorbeeld factuur</div>
      <div>
        <a href="javascript:window.print()" class="btn primary">Print / PDF</a>
        <a href="/admin/core/invoice/{{ invoice.pk }}/change/" class="btn">Terug naar admin</a>
      </div>
    </div>

    <div class="card">

      {# Logo: altijd zichtbaar op scherm; print alleen bij digitaal #}
      {% if request.GET.papier|default:"digitaal" == "voorbedrukt" %}
        <img src="{% static 'branding/spiegelven-logo.svg' %}" alt="Spiegelven" class="brand-logo screen-only">
      {% else %}
        <img src="{% static 'branding/spiegelven-logo.svg' %}" alt="Spiegelven" class="brand-logo">
      {% endif %}

      {# Stempel rechtsboven: FACTUUR of CREDITNOTA #}
      <div class="doc-stamp">
        {% with kind=invoice.doc_type|stringformat:"s"|lower %}
          {% if kind == "credit" or kind == "creditnote" or kind == "credit_note" or kind == "cn" %}
            CREDITNOTA
          {% else %}
            FACTUUR
          {% endif %}
        {% endwith %}
      </div>

      <hr>

      <div class="meta-box">
        <div class="meta-grid">
          <div class="meta-cell left">
            <span class="label">Datum:</span>
            <span class="value">{{ invoice.issue_date|date:"d/m/Y" }}</span>
          </div>
          <div class="meta-cell center">
            <span class="label">Factuurnummer:</span>
            <span class="value">{{ invoice.number|default:"(nog geen nummer)" }}</span>
          </div>
          <div class="meta-cell right">
            <span class="label">Status:</span>
            <span class="value">{{ invoice.get_status_display|default:invoice.status }}</span>
          </div>
        </div>
      </div>

      {% if invoice.notes %}
        <div class="note-box">
          <div class="note-body">{{ invoice.notes }}</div>
        </div>
      {% endif %}

      <div class="table">
        <table>
          <thead>
            <tr>
              <th style="width:46%">Omschrijving</th>
              <th class="num" style="width:9%">Aantal</th>
              <th class="num" style="width:15%">Eenheidsprijs</th>
          <th class="num" style="width:8%"></th>              
              <th class="num" style="width:11%">Excl.</th>
              <th class="num" style="width:11%">BTW</th>
              <th class="num" style="width:11%">Incl.</th>
            </tr>
          </thead>
          <tbody>
            {% for l in lines %}
              <tr>
                <td>{{ l.description }}</td>
                <td class="num">{{ l.quantity|eur:"0" }}</td>
                <td class="num">{{ l.unit_price_excl|eur }}</td>
          <td class="num">{{ l.vat_rate|floatformat:"0" }}%</td>                <td class="num">{{ l.line_excl|eur }}</td>
                <td class="num">{{ l.vat_amount|eur }}</td>
                <td class="num">{{ l.line_incl|eur }}</td> 
              </tr>
            {% empty %}
              <tr>
                <td colspan="7" class="muted">Geen regels.</td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>

      {% if vat_summary %}
      <div style="margin-top:12px">
        <div class="box-title">Samenvatting per BTW-tarief</div>
        <table>
          <thead>
            <tr>
              <th>Tarief</th>
              <th class="num">Excl.</th>
              <th class="num">BTW</th>
              <th class="num">Incl.</th>
            </tr>
          </thead>
          <tbody>
            {% for r in vat_summary %}
            <tr>
              <td>{{ r.rate }}</td>
              <td class="num">{{ r.excl|eur }}</td>
              <td class="num">{{ r.vat|eur }}</td>
              <td class="num">{{ r.incl|eur }}</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
      {% endif %}

      <div class="summary-row">

        <div class="pay-card">
          <div class="pay-title">Betalingsgegevens :</div>
          <div class="row">
            <span class="label">Op naam van</span>
            <span class="value">{{ org.name }}</span>
          </div>

          {% if payment.iban %}
          <div class="row">
            <span class="label">IBAN</span>
            <span class="value">{{ payment.iban }}</span>
            {% if payment.bic %}
              <span class="sep">·</span>
              <span class="label">BIC</span>
              <span class="value">{{ payment.bic }}</span>
            {% endif %}
          </div>
          {% endif %}

          {% if payment.ogm %}
            <div class="row">
              <span class="label">Gestructureerde mededeling:</span>
              <span class="value ogm">{{ payment.ogm|ogm }}</span>
            </div>
          {% endif %}
        </div>

        <div class="totals-card">
          <div class="row">
            <div class="label">Totaal excl.</div>
            <div class="value">
              <span class="curr">€</span>
              <span class="int">{{ totals_parts.excl.int }}</span><span class="dec">,{{ totals_parts.excl.dec }}</span>
            </div>
          </div>
          <div class="row">
            <div class="label">BTW</div>
            <div class="value">
              <span class="curr">€</span>
              <span class="int">{{ totals_parts.vat.int }}</span><span class="dec">,{{ totals_parts.vat.dec }}</span>
            </div>
          </div>
          <div class="row total">
            <div class="label">Totaal incl.</div>
            <div class="value">
              <span class="curr">€</span>
              <span class="int">{{ totals_parts.incl.int }}</span><span class="dec">,{{ totals_parts.incl.dec }}</span>
            </div>
          </div>
        </div>

      </div>

    </div> <!-- /.card -->

  </div>   <!-- /.wrap -->

  {% if request.GET.papier|default:"digitaal" == "digitaal" %}
    {% include "invoices/_footer_org.html" %}
  {% endif %}

</body>
</html>
